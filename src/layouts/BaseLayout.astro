---
// BaseLayout: Tailwind + lokale Fonts + ohne Font Awesome
import '../styles/tailwind.css';
import '@fontsource-variable/geist';
import '@fontsource-variable/space-grotesk';

import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import JsonLd from '../components/seo/JsonLd.astro';
import { buildBaseGraph } from '../lib/structuredData';
import { browserAppConfig } from '../config/minecraftGilde';

export interface Props {
  title?: string;
  canonical?: string;
  description?: string;
  keywords?: string;
  author?: string;

  /** Wenn true: robots auf noindex/nofollow setzen */
  noindex?: boolean;

  /** OpenGraph / Twitter Metadaten */
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string; // relativ (/og/...) oder absolut
  ogType?: 'website' | 'article';
  twitterCard?: 'summary' | 'summary_large_image';
  twitterSite?: string;

  bodyClass?: string;
  showNav?: boolean;
  showFooter?: boolean;
  scripts?: string[];
}

const {
  title = 'Minecraft Gilde',
  canonical,
  description,
  keywords,
  author = 'Christian Falkner',

  noindex = false,

  ogTitle,
  ogDescription,
  ogImage = '/og/og-default.jpg',
  ogType = 'website',
  twitterCard = 'summary_large_image',
  twitterSite,

  bodyClass = '',
  showNav = true,
  showFooter = true,
  scripts = [],
} = Astro.props as Props;

// Absolute URLs (wichtig fuer OG/Twitter)
const site = Astro.site ?? new URL('https://minecraft-gilde.de');
const canonicalUrl = canonical ?? new URL(Astro.url.pathname, site).toString();

const metaTitle = title;
const metaDescription =
  description ??
  'Minecraft Gilde â€“ Langzeitwelt ohne Resets. Fair ohne Pay-to-Win. Vanilla+ Komfort.';

const finalOgTitle = ogTitle ?? metaTitle;
const finalOgDescription = ogDescription ?? metaDescription;

const finalOgImage = ogImage.startsWith('http') ? ogImage : new URL(ogImage, site).toString();

// ---
// Strukturierte Daten (JSON-LD)
// ---
const ldBase = buildBaseGraph({
  site,
  canonicalUrl,
  pathname: Astro.url.pathname,
  title: metaTitle,
  description: metaDescription,
  ogImage: finalOgImage,
});
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    {keywords ? <meta name="keywords" content={keywords} /> : null}
    {author ? <meta name="author" content={author} /> : null}
    <meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow'} />

    {/* Theme-Farbe (wird dynamisch an --bg angepasst) */}
    <meta name="theme-color" content="#0b0f14" />

    {/* Icons / PWA */}
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />

    {/* OpenGraph */}
    <meta property="og:locale" content="de_DE" />
    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content="Minecraft Gilde" />
    <meta property="og:title" content={finalOgTitle} />
    <meta property="og:description" content={finalOgDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={finalOgImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Minecraft Gilde" />

    {/* Twitter */}
    <meta name="twitter:card" content={twitterCard} />
    {twitterSite ? <meta name="twitter:site" content={twitterSite} /> : null}
    <meta name="twitter:title" content={finalOgTitle} />
    <meta name="twitter:description" content={finalOgDescription} />
    <meta name="twitter:image" content={finalOgImage} />

    {/* Strukturierte Daten (global + WebPage + Breadcrumbs/Navigationspfad) */}
    <JsonLd data={ldBase} />

    <script is:inline>
      // Theme-Bootstrap (verhindert Flash). Werte: 'light' | 'dark' | 'system'
      try {
        const stored = localStorage.getItem('theme');
        const root = document.documentElement;
        if (stored === 'light' || stored === 'dark') root.dataset.theme = stored;
        else root.removeAttribute('data-theme');
      } catch {
        // Optional: Fehler ignorieren, damit das Rendering nicht blockiert.
      }
    </script>

    <script is:inline>
      // Theme-Farbe mit dem aktiven Theme synchron halten (nutzt CSS-Variable --bg).
      try {
        const meta = document.querySelector('meta[name="theme-color"]');
        const root = document.documentElement;

        const update = () => {
          const bg = getComputedStyle(root).getPropertyValue('--bg').trim();
          if (meta && bg) meta.setAttribute('content', bg);
        };

        // Erstes Update (nach dem Theme-Bootstrap oben)
        update();

        // Auf manuelle Theme-Wechsel reagieren (data-theme)
        const obs = new MutationObserver(update);
        obs.observe(root, { attributes: true, attributeFilter: ['data-theme'] });

        // Auf System-Theme-Wechsel reagieren (wenn kein Override gesetzt ist)
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', update);

        window.addEventListener('DOMContentLoaded', update);
      } catch {
        // Optional: Fehler ignorieren, damit das Rendering nicht blockiert.
      }
    </script>

    <script is:inline define:vars={{ browserAppConfig }}>
      // Globale App-Config fuer Client-Skripte
      window.__APP_CONFIG__ = browserAppConfig;
    </script>

    <slot name="head" />
  </head>

  <body class={`min-h-dvh flex flex-col bg-bg text-fg antialiased ${bodyClass}`.trim()}>
    <a
      href="#main"
      class="bg-surface-solid text-fg border-border sr-only rounded-lg border px-3 py-2 text-sm font-medium focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-50"
    >
      Zum Inhalt springen
    </a>

    <div class="pointer-events-none fixed inset-0 -z-10 overflow-hidden">
      <div class="mg-page-bg absolute inset-0"></div>
    </div>

    {showNav ? <Navbar /> : null}

    <main id="main" class="flex-1">
      <slot />
    </main>

    {showFooter ? <Footer /> : null}

    <div
      id="toast"
      class="pointer-events-none fixed bottom-4 left-1/2 z-[60] hidden -translate-x-1/2"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>

    <script src="/js/app.js" defer is:inline></script>
    {scripts.map((src) => <script src={src} defer is:inline />)}
    <slot name="afterScripts" />
  </body>
</html>
