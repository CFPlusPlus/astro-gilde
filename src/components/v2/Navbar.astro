---
import { Menu, X, ExternalLink } from '@lucide/astro';
import Button from './ui/Button.astro';
import Badge from './ui/Badge.astro';

type NavItem = { href: string; label: string; external?: boolean };

const PRIMARY_LINKS: NavItem[] = [
  { href: '/v2/', label: 'Start' },
  { href: '/serverinfos', label: 'Serverinfo' },
  { href: '/rules', label: 'Regeln' },
  { href: '/stats', label: 'Statistiken' },
];

const MORE_LINKS: NavItem[] = [
  { href: '/erststart', label: 'Erststart' },
  { href: '/befehle', label: 'Befehle' },
  { href: '/geschichte', label: 'Geschichte' },
  { href: '/admin-team', label: 'Admin-Team' },
  { href: '/playerstats', label: 'Spieler' },
  { href: '/datenschutz', label: 'Datenschutz' },
  { href: '/impressum', label: 'Impressum' },
  { href: '/', label: 'Aktuelle Seite' },
];

const DISCORD: NavItem = { href: 'https://discord.minecraft-gilde.de', label: 'Discord', external: true };
---

<header class="sticky top-0 z-50" data-v2-nav>
  <div class="mx-auto max-w-6xl px-4 pt-4">
    <div class="glass rounded-[var(--radius)] px-4 py-3 shadow-sm">
      <div class="flex items-center justify-between gap-4">
        <a href="/v2/" class="flex items-center gap-3" aria-label="Minecraft Gilde (Start)">
          <img
            src="/images/logo.webp"
            width="36"
            height="36"
            alt="Minecraft Gilde"
            class="h-9 w-9 rounded-lg"
            loading="eager"
            decoding="async"
          />
          <div class="hidden sm:block leading-tight">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold">Minecraft Gilde</span>
              <Badge variant="accent" class="hidden md:inline-flex">v2 preview</Badge>
            </div>
            <span class="text-xs text-muted">clean · glass · minimal</span>
          </div>
        </a>

        <nav class="hidden md:flex items-center gap-1" aria-label="Hauptnavigation">
          {PRIMARY_LINKS.map((item) => (
            <a
              href={item.href}
              class="rounded-lg px-3 py-2 text-sm font-medium text-fg/90 hover:text-fg hover:bg-surface border border-transparent hover:border-border transition-colors"
            >
              {item.label}
            </a>
          ))}
        </nav>

        <div class="flex items-center gap-2">
          <Button
            href={DISCORD.href}
            external
            variant="primary"
            class="hidden sm:inline-flex"
          >
            Discord
            <ExternalLink size={16} />
          </Button>

          <button
            type="button"
            class="inline-flex h-10 w-10 items-center justify-center rounded-lg border border-border bg-surface hover:bg-surface-solid/70 backdrop-blur-md transition-colors md:hidden"
            aria-label="Menü öffnen"
            aria-controls="v2-nav-panel"
            aria-expanded="false"
            data-nav-toggle
          >
            <Menu size={20} data-icon-open />
            <X size={20} class="hidden" data-icon-close />
          </button>
        </div>
      </div>
    </div>

    <div
      id="v2-nav-panel"
      class="hidden md:hidden mt-3"
      data-nav-panel
    >
      <div class="glass rounded-[var(--radius)] p-3 shadow-sm">
        <div class="grid gap-1">
          {PRIMARY_LINKS.map((item) => (
            <a
              href={item.href}
              class="rounded-lg px-3 py-2 text-sm font-medium text-fg hover:bg-surface border border-transparent hover:border-border transition-colors"
            >
              {item.label}
            </a>
          ))}
        </div>

        <div class="my-3 h-px bg-border"></div>

        <div class="grid sm:grid-cols-2 gap-1">
          {MORE_LINKS.map((item) => (
            <a
              href={item.href}
              class="rounded-lg px-3 py-2 text-sm text-fg/90 hover:text-fg hover:bg-surface border border-transparent hover:border-border transition-colors"
            >
              {item.label}
            </a>
          ))}
        </div>

        <div class="mt-3">
          <Button href={DISCORD.href} external variant="primary" class="w-full">
            Discord
            <ExternalLink size={16} />
          </Button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.querySelector('[data-v2-nav]');
      if (!root) return;

      const toggle = root.querySelector('[data-nav-toggle]');
      const panel = root.querySelector('[data-nav-panel]');
      const iconOpen = root.querySelector('[data-icon-open]');
      const iconClose = root.querySelector('[data-icon-close]');

      if (!toggle || !panel || !iconOpen || !iconClose) return;

      let open = false;

      const setOpen = (next) => {
        open = next;
        panel.classList.toggle('hidden', !open);
        toggle.setAttribute('aria-expanded', String(open));
        iconOpen.classList.toggle('hidden', open);
        iconClose.classList.toggle('hidden', !open);
      };

      const close = () => setOpen(false);

      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        setOpen(!open);
      });

      // Close on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!open) return;
        if (e.target instanceof Node && !root.contains(e.target)) close();
      });

      // Close when switching to desktop layout
      window.addEventListener('resize', () => {
        if (window.matchMedia('(min-width: 768px)').matches) close();
      });

      // Close when a link is clicked
      panel.querySelectorAll('a').forEach((a) => a.addEventListener('click', close));
    })();
  </script>
</header>
