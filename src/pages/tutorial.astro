---
import { getCollection } from 'astro:content';
import { ArrowRight, Copy, Hammer, Map, Shield, UserRound, Vote, Wand } from '@lucide/astro';
import Button from '../components/ui/Button.astro';
import Callout from '../components/ui/Callout.astro';
import Card from '../components/ui/Card.astro';
import JsonLd from '../components/seo/JsonLd.astro';
import { minecraftGilde } from '../config/minecraftGilde';
import { canonicalFor } from '../config/site';
import {
  isTutorialExternalTarget,
  resolveTutorialLink,
  tutorialFinalCallout,
  tutorialHeaderActions,
  tutorialHeaderIntro,
  tutorialHowTo,
  tutorialQuickstart,
  tutorialQuickstartActions,
} from '../data/tutorial';
import BaseLayout from '../layouts/BaseLayout.astro';
import { buildHowTo } from '../lib/structuredData';

const canonicalUrl = canonicalFor(Astro.url.pathname);

const SERVER_IP = minecraftGilde.serverIp;

const howToLd = buildHowTo({
  canonicalUrl,
  name: tutorialHowTo.name,
  description: tutorialHowTo.description,
  steps: tutorialHowTo.steps.map((step) => ({
    name: step.name,
    text: step.text,
    ...(step.target
      ? {
          url: isTutorialExternalTarget(step.target)
            ? resolveTutorialLink(step.target)
            : canonicalFor(resolveTutorialLink(step.target)),
        }
      : null),
  })),
});

const SECTION_ICONS = {
  Wand,
  Shield,
  Hammer,
  UserRound,
  Map,
  Vote,
} as const;

const ACTION_ICONS = {
  ArrowRight,
  Shield,
  Hammer,
  Map,
  Vote,
} as const;

type SectionIconName = keyof typeof SECTION_ICONS;
type ActionIconName = keyof typeof ACTION_ICONS;

const sectionEntries = (await getCollection('tutorial')).sort(
  (a, b) => a.data.order - b.data.order,
);

const sections = await Promise.all(
  sectionEntries.map(async (entry) => {
    const { Content } = await entry.render();

    return {
      ...entry.data,
      Content,
    };
  }),
);
---

<BaseLayout title="Minecraft Gilde - Tutorial" canonical={canonicalUrl}>
  <JsonLd slot="head" data={howToLd} />

  <section class="mg-container pt-12 pb-6">
    <h1 class="text-3xl font-semibold tracking-tight">{tutorialHeaderIntro.title}</h1>
    <p class="text-muted mt-2">{tutorialHeaderIntro.subtitle}</p>

    <div class="mt-6 flex flex-wrap gap-3">
      <Button variant="primary" class="gap-2" data-copy-ip><Copy size={18} /> IP kopieren</Button>
      {
        tutorialHeaderActions.map((action) => {
          const Icon = action.icon ? ACTION_ICONS[action.icon as ActionIconName] : null;

          return (
            <Button
              href={resolveTutorialLink(action.target)}
              external={isTutorialExternalTarget(action.target)}
              variant={action.variant}
              class="gap-2"
            >
              {action.label}
              {Icon && <Icon size={18} />}
            </Button>
          );
        })
      }
    </div>
  </section>

  <section class="mg-container pb-16">
    <Card class="p-6">
      <h2 class="text-xl font-semibold tracking-tight">{tutorialQuickstart.title}</h2>
      <p class="text-muted mt-2 text-sm">{tutorialQuickstart.subtitle}</p>

      <ol class="text-muted mt-4 list-decimal space-y-2 pl-5 text-sm">
        {
          tutorialQuickstart.steps.map((step) => (
            <li>
              <span class="text-fg/90 font-medium">{step.title}</span>: {step.text}
            </li>
          ))
        }
      </ol>

      <div class="mt-5 flex flex-wrap gap-2">
        {
          tutorialQuickstartActions.map((action) => {
            const Icon = action.icon ? ACTION_ICONS[action.icon as ActionIconName] : null;

            return (
              <Button
                href={resolveTutorialLink(action.target)}
                external={isTutorialExternalTarget(action.target)}
                variant={action.variant}
                class="gap-2"
              >
                {Icon && <Icon size={18} />}
                {action.label}
              </Button>
            );
          })
        }
      </div>
    </Card>

    <div class="mt-6 space-y-3">
      {
        sections.map((section) => {
          const SectionIcon = SECTION_ICONS[section.icon as SectionIconName];

          return (
            <details class="mg-accordion" open={section.open}>
              <summary class="flex items-center justify-between gap-3">
                <span class="inline-flex items-center gap-2 text-sm font-semibold">
                  <SectionIcon size={18} /> {section.title}
                </span>
                <span class="text-muted text-xs">{section.meta}</span>
              </summary>

              <div class="mg-prose mt-4">
                <section.Content />
              </div>

              {section.actions?.length ? (
                <div class="mt-3 flex flex-wrap gap-2">
                  {section.actions.map((action) => {
                    const ActionIcon = action.icon
                      ? ACTION_ICONS[action.icon as ActionIconName]
                      : null;

                    return (
                      <Button
                        href={resolveTutorialLink(action.target)}
                        external={isTutorialExternalTarget(action.target)}
                        variant={action.variant}
                        class="gap-2"
                      >
                        {ActionIcon && <ActionIcon size={18} />}
                        {action.label}
                      </Button>
                    );
                  })}
                </div>
              ) : null}
            </details>
          );
        })
      }

      <Callout variant={tutorialFinalCallout.variant} title={tutorialFinalCallout.title}>
        <p>{tutorialFinalCallout.text}</p>
      </Callout>

      <p class="text-muted text-xs">IP: {SERVER_IP}</p>
    </div>
  </section>
</BaseLayout>
