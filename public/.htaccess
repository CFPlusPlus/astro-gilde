# sichergehen, dass benötigte Module aktiv sind 
<IfModule mod_headers.c>
</IfModule>
<IfModule mod_expires.c>
    ExpiresActive On
</IfModule>

#UTF-8 als Standard setzen
AddCharset UTF-8 .txt

# MIME-Types für moderne Bildformate (wichtig für Safari/iOS)
<IfModule mod_mime.c>
  AddType image/webp .webp
  AddType image/avif .avif
</IfModule>

# 404-Seite (kompatibel: /404.html wird beim Build erzeugt)
ErrorDocument 404 /404.html
# Caching-Strategie:
# - HTML: no-cache + must-revalidate, damit Clients immer revalidieren (ohne no-store Widerspruch).
# - JSON/API: kurze TTL + Revalidierung, damit Daten zeitnah aktualisiert werden.
# - CSS/JS: lange TTL mit immutable fuer Astro-Build-Assets (gehashte Dateien in /_astro/),
#           sonst moderates Caching fuer ungehashte Dateien.
# - Images/Fonts: lange TTL fuer statische Dateien.
<IfModule mod_headers.c>
  # HTML-Dokumente: immer revalidieren
  <FilesMatch "\.(?:html?)$">
    Header set Cache-Control "no-cache, must-revalidate"
    Header set Pragma "no-cache"
  </FilesMatch>

  # JSON/API: kurz cachen, dann revalidieren
  <FilesMatch "\.(?:json)$">
    Header set Cache-Control "max-age=300, must-revalidate, stale-while-revalidate=86400"
  </FilesMatch>

  # Gehashte Build-Assets (Astro: /_astro/) markieren
  <IfModule mod_setenvif.c>
    SetEnvIfNoCase Request_URI "^/_astro/.*\.(?:css|js|mjs)$" IS_HASHED_ASTRO_ASSET=1
  </IfModule>

  # CSS/JS: gehashte Assets lang+immutable, ungehashte moderat
  <FilesMatch "\.(?:css|js|mjs)$">
    Header set Cache-Control "public, max-age=31536000, immutable" env=IS_HASHED_ASTRO_ASSET
    Header set Cache-Control "public, max-age=3600, must-revalidate" env=!IS_HASHED_ASTRO_ASSET
  </FilesMatch>

  # Bilder/Fonts: lange cachen
  <FilesMatch "\.(?:woff2?|ttf|eot|gif|png|jpg|jpeg|webp|avif|svg|ico)$">
    Header set Cache-Control "public, max-age=31536000"
  </FilesMatch>
</IfModule>
# Kompression aktivieren
<IfModule mod_deflate.c>
    # Text, HTML, JavaScript, CSS, XML und JSON komprimieren
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml

    # Bilder und andere bereits komprimierte Inhalte ausschließen
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|bz2|woff2|ico|pdf|mp4|mp3)$ no-gzip dont-vary

    # Browser-Kompatibilität sicherstellen
    Header append Vary Accept-Encoding
</IfModule>
# Redirects / pretty URLs
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Altes Sitemap-URL weiterhin erreichbar halten
  RewriteRule ^sitemap\.xml$ /sitemap-index.xml [R=301,L]

  # --- 301 Weiterleitungen: alte URLs -> neue Seitenstruktur ---
  RewriteRule ^rules/?$ /regeln/ [R=301,L,NC]
  RewriteRule ^rules\.html$ /regeln/ [R=301,L,NC]

  RewriteRule ^stats/?$ /statistiken/ [R=301,L,NC]
  RewriteRule ^stats\.html$ /statistiken/ [R=301,L,NC]

  RewriteRule ^playerstats/?$ /statistiken/spieler/ [R=301,L,NC]
  RewriteRule ^playerstats\.html$ /statistiken/spieler/ [R=301,L,NC]

  # Legacy-Seiten aus der alten Website
  RewriteRule ^erststart\.html$ /tutorial/ [R=301,L,NC]
  RewriteRule ^admin-team\.html$ /team/ [R=301,L,NC]

  # Strip .html from requests (e.g. /seite.html -> /seite/)
  RewriteCond %{THE_REQUEST} \s/+(.*)\.html[\s?] [NC]
  RewriteRule ^ %1/ [R=301,L]

  # Strip /index.html
  RewriteCond %{THE_REQUEST} \s/+(.*)/index\.html[\s?] [NC]
  RewriteRule ^ %1/ [R=301,L]
</IfModule>
